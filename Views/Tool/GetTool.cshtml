@model PlusCP.Models.Tool
@{
    ViewBag.Title = "GetTool";
    Layout = null;

}
<link href="~/Content/css/message.css" rel="stylesheet" />
<link href="~/Content/css/jquery.dataTables.colResize.css" rel="stylesheet" />
<link href="~/Content/css/GetPO.css" rel="stylesheet" />

<style>
    /* Add User Modal */

    /* Refresh Button */
    .btn-refresh {
        background-color: #003B59 !important; /* Distinct orange color */
        color: white !important;
        border-radius: 30px !important;
        margin-left: 5px !important;
        height: 25px !important;
        padding: 0px 12px !important;
        border: 2px solid #003B59 !important;
        transition: all 0.3s ease-in-out;
    }

        .btn-refresh:hover {
            background-color: white !important;
            color: #003B59 !important;
            border: 2px solid #003B59 !important;
        }


    .RedColor {
        color: red;
    }

    .GreenColor {
        color: green;
    }

    .required:after {
        content: " *";
        color: red;
    }

    .datepicker td, th {
        text-align: center;
        padding: 8px 12px;
        font-size: 14px;
    }

    .Message {
        height: 200px;
        width: 500px
    }

    /*.custom-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #ccc;
    }

    .custom-modal-title {
        margin: 0;
    }

    .custom-modal-header .close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        font-size: 1.5rem;
        line-height: 1;
    }*/

    .table.dataTable {
        font-family: "Segoe UI", "Roboto";
        clear: both;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 16px;
    }

    .dataTables_wrapper,
    .dataTables_length,
    .dataTables_filter,
    .dataTables_info,
    .dataTables_paginate,
    table.dataTable thead th,
    table.dataTable tbody td {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif !important;
    }

        .dataTables_wrapper .dataTables_paginate {
            text-align: left !important;
            float: none !important;
            display: flex;
            justify-content: left;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif !important;
        }

            .dataTables_wrapper .dataTables_paginate .paginate_button {
                font-size: 15px !important; /* Increase font size */
                padding: 8px 12px; /* Increase button padding */
                color: #003B59 !important;
            }

        .dataTables_wrapper .dataTables_paginate {
            margin-left: 60px !important; /* Adjust this value as needed */
        }

            .dataTables_wrapper .dataTables_paginate .paginate_button i {
                font-size: 15px !important; /* Increase icon size */
                color: #003B59 !important;
            }

        .dataTables_wrapper .dataTables_info {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif !important;
            font-size: 16px !important; /* Adjust size */
            color: #333 !important; /* Darker text */
            margin-left: 5px;
        }
    /* Change odd row background color */
    table.dataTable tbody tr:nth-child(odd) {
        background-color: #ECEDEF; /* Change to your desired color */
    }

    /* Change even row background color */
    table.dataTable tbody tr:nth-child(even) {
        background-color: #ffffff; /* Change to your desired color */
    }

    table.dataTable tbody tr.selected {
        background-color: #D6EFE8; /* Orange color */
        /*color: white;*/ /* Change text color if needed */
    }
    /* Search icon inside input */
    .search-icon {
        position: absolute;
        top: 50%;
        left: 8px;
        transform: translateY(-50%);
        color: darkgrey;
        font-size: 14px;
        pointer-events: none; /* Prevents clicking on the icon */
    }

    .search-container {
        position: relative;
        display: inline-block;
    }

    .txtSearch-frame {
        margin-top: 5px;
        height: 28px;
        width: 150px;
        border: none;
        color: #003B59;
        border: 2px solid #003B59 !important;
        width: 200px;
        padding-left: 30px; /* Space for the icon */
    }

    .pdf-icon {
        width: 30px;
        height: 30px;
        image-rendering: crisp-edges;
        image-rendering: -webkit-optimize-contrast;
    }

    .pad {
        padding-bottom: 15px;
        padding: 2px;
        padding-top: 10px;
    }

    .lblHeading {
        font-size: 19px;
        color: #003B59 !important;
    }

    .table-container {
        height: 200px; /* Set the desired fixed height */
        overflow-y: auto;
    }

    /*table > thead > tr > th {
        background-color: gray !important;
        color: white;
    }*/

    table.table thead th {
        background-color: #003B59 !important; /* Change to your desired color */
        color: white; /* Change to desired text color */
        font-size: 15px;
        font-family: 'Poppins', sans-serif;
        height: 40px;
    }

    table.table tbody td, lbl_ {
        /*background-color: white !important; /* Change to your desired color */
        font-size: 15px;
        color: #003B59 !important;
    }

    table.table tbody tr {
        height: 50px; /* Adjust height as needed */
    }

        /* Hover effect */
        table.table tbody tr:hover {
            background-color: #f5f5f5 !important; /* Light gray background on hover */
            transition: background-color 0.8s ease-in-out;
            cursor: pointer;
        }




    table th {
        /*padding: 1rem 0.5rem !important;*/
        border: 1px solid black;
        border-bottom: 1px solid black;
        /*padding: 8px;*/
        text-align: left;
    }

    table td {
        padding: 1rem 0.5rem !important;
        font-size: 15px !important;
        font-weight: 500 !important;
        vertical-align: middle;
    }

    table {
        border-collapse: separate;
        border-spacing: 0 10px; /* Adjust the second value to increase/decrease the vertical gap */
        width: 100%;
    }

        table.table-bordered.dataTable tbody th, table.table-bordered.dataTable tbody td {
            border-bottom-width: 1px;
        }




    .sticky-header th {
        position: sticky;
        top: 0;
        background-color: #f2f2f2;
    }



    .t-head {
        color: #023160;
    }

    /* Modal Styling */
    .modal-dialog {
        margin: 30px auto;
    }

        .modal-dialog.centered {
            display: flex;
            min-height: calc(100vh - 60px);
            align-content: stretch;
            flex-wrap: wrap;
            align-items: stretch;
            flex-direction: column;
            justify-content: center;
            width: 32%;
            overflow: auto;
        }

    .box-header {
        background-color: #f8f9fc !important;
        color: #003B59 !important;
        border-bottom: 2px solid #f8f9fc;
        box-shadow: 0px 5px #ededed;
    }


    .btn-box-tool {
        color: #003B59 !important;
    }


    /*/Badges/*/

    .btn-badges {
        color: #003B59 !important;
        border-radius: 25px !important;
        margin-left: 5px !important;
        height: 25px !important;
        padding: 2px 12px !important;
    }

        .btn-badges:hover {
            background-color: #003B59 !important;
            color: white !important;
        }

            .btn-badges:hover .badge_light {
                background-color: white !important;
                color: #003B59 !important;
            }

    .badge_light {
        background-color: #003B59 !important;
        color: white !important;
    }

    .btn-badges-Sent {
        border-radius: 25px !important;
        height: 25px !important;
        width: 60px;
    }

    .selected {
        background-color: deepskyblue !important;
        color: black;
    }

    .ModalHeaderColor {
        background-color: #D6EFE8;
        color: #003B59
    }

    .ModalLabelColor {
        color: #003B59;
        text-align: center;
        font-weight: bold;
    }

    textarea {
        resize: none;
    }

    .password-wrapper {
        position: relative;
    }

        .password-wrapper .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #777;
            z-index: 2;
            border: none;
            background: none;
        }

        .password-wrapper input {
            padding-right: 35px; /* Leave space for the icon */
        }


    .dots-text {
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
        padding: 4px 8px;
        color: #333;
        user-select: none;
        transition: color 0.2s ease;
    }

        .dots-text:hover {
            color: #007bff;
        }

    .dropdown-custom {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        background: #fff;
        min-width: 160px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        z-index: 2147483647;
    }

    .dropdown-custom.show .dropdown-content {
        display: block;
    }

    .dropdown-content a {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        color: #333;
        text-decoration: none;
        font-size: 14px;
        transition: background 0.2s ease;
    }

        .dropdown-content a:hover {
            background: #f0f0f0;
        }

        .dropdown-content a .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }


    #checkOutModal .modal-body {
        max-height: 70vh; /* modal body ki height screen ka 70% */
        overflow-y: auto; /* vertical scroll enable */
        overflow-x: hidden; /* horizontal scroll band */
    }

    /* Modal ko full width tak expand karne ke liye */
    .modal-dialog.custom-modal {
        max-width: 90% !important;
        width: 90% !important;
    }
    toolCheckinGridBody
    /* Notes column thoda aur wide aur textarea responsive */
    #toolCheckoutGrid th:last-child,
    #toolCheckoutGrid td:last-child {
        width: 35% !important;
    }

    /* ✅ Table full width + scroll */
    #toolCheckinGrid {
        width: 100%;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

        /* ✅ Header row fixed height */
        #toolCheckinGrid thead th {
            white-space: nowrap;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            height: 40px;
        }

    /* ✅ Body row height set */
    #toolCheckinGridBody td {
        white-space: nowrap;
        vertical-align: middle !important;
        padding: 5px 8px !important;
    }

   


    #toolCheckoutGrid textarea {
        width: 100%;
        resize: vertical;
    }

    /* Optional: thoda spacing aur modal scroll control */
    .modal-body {
        max-height: 80vh;
        min-height: 70vh;
        overflow-y: auto;
        overflow-x: auto;
    }

    .multiselect-container {
        position: absolute !important;
        z-index: 2000 !important;
    }

    #toolCheckinGrid select.form-control {
        min-width: 150px;
        max-width: 250px;
    }

    #toolCheckinGrid td {
        vertical-align: middle;
    }


    /* Compact repair cell */
    .repair-item {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 4px;
    }

        .repair-item label {
            font-size: 12px;
            margin-bottom: 0;
            color: #444;
        }

    .repairAction {
        height: 28px !important;
        font-size: 12px !important;
        padding: 2px 6px;
        border-radius: 4px;
    }

    /* Serial text small and neat */
    .serial-item {
        font-size: 13px;
        color: #333;
    }

    /* Part dropdown always visible */
    .partDropdown {
        height: 32px !important;
        font-size: 13px !important;
        border-radius: 4px;
    }

    .star-rating span {
        font-size: 18px;
        cursor: pointer;
        color: #ccc; /* default grey */
        margin-right: 2px;
    }

        .star-rating span.selected-star {
            color: gold !important;
        }

        .star-rating span:hover {
            color: gold;
        }

        .star-rating span:focus,
        .star-rating span:active {
            outline: none;
            box-shadow: none;
        }




</style>

<div id="parent" class="container-fluid">
    <input id="rptCode" type="hidden" value="019" />
    <input id="rptTitle" class="lblHeading" type="hidden" value="@ViewBag.ReportTitle" />
    <div id="dataLists" class="box panel panel-default">
        <div class="box-header with-border">

            <h5 class="box-title"><strong>@ViewBag.ReportTitle  </strong><strong id="filterString"></strong></h5>
            <button id="GetToolList" class="btn btn-badges">
                Refresh
            </button>

            <button id="btnMultiCheckout" class="btn btn-badges">
                <i class="fa fa-sign-out-alt icon text-danger"></i> Check-Out
            </button>
            <button id="btnMultiCheckin" class="btn btn-badges">
                <i class="fa fa-sign-in-alt icon text-success"></i> Check-In
            </button>

            <div id="buttons" class="box-tools pull-right">

            </div>
        </div>

        <div class="box-body" id="lstP">
            <table id="lstGetTool" class="table table-bordered table-striped text-sm table-hover" style="width:100%">
                <thead class="sorted-asc">
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                    </tr>
                </tfoot>
            </table>
        </div>

    </div>
</div>


<!-- Check-Out Modal -->
<div class="modal fade" id="checkOutModal" tabindex="-1" role="dialog" aria-labelledby="checkOutLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg custom-modal" role="document">

        <div class="modal-content">

            <div class="modal-header ModalHeaderColor">
                <h5 class="modal-title ModalLabelColor">Tool Check-Out</h5>
            </div>

            <div class="modal-body">
                <form id="checkOutForm">
                    <input type="hidden" id="checkoutToolIds" name="ToolIds" />

                    <div class="form-group col-md-4">
            <label>Select User:</label>
            <select id="loadUsersDropdown" class="form-control" required>
                        <option value="">-- Select User --</option>
                    </select>
        </div>

                    @*<select id="loadUsersDropdown" class="form-control" required>
                        <option value="">-- Select User --</option>
                    </select>*@



                    <!-- GRID -->
                    <table class="table table-bordered table-sm" id="toolCheckoutGrid" style="width:100%">
                        <thead class="thead-light">
                            <tr>
                                <th style="text-align:center">Tool Name</th>
                                <th>Serial No</th>
                                <th>Part No</th>
                                <th>Expected Return Date</th>
                                <th style="width: 30%;">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="toolGridBody">
                            <!-- Rows dynamically add honge -->
                        </tbody>
                    </table>
                </form>
            </div>

            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
                <button id="btnCheckout" type="submit" form="checkOutForm" class="btn btn-danger btn-sm">Confirm Check-Out</button>
            </div>

        </div>
    </div>
</div>
<div id="modalLoader"
     style="display:none; position:absolute; top:0; left:0; right:0; bottom:0;
            background:rgba(255,255,255,0.8); z-index:9999;
            justify-content:center; align-items:center;">
    <div class="spinner-border text-danger" role="status"></div>
</div>




<!-- ✅ Tool Check-In Modal -->
<div class="modal fade" id="checkInModal" tabindex="-1" role="dialog" aria-labelledby="checkInLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl custom-modal" role="document">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header ModalHeaderColor">
                <h5 class="modal-title ModalLabelColor">Tool Check-In (Serial Wise)</h5>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <form id="checkInForm">
                    <input type="hidden" id="checkinToolIds" name="ToolIds" />

                    <!-- Email + Password -->
                    <!--<div class="form-row mb-3">
                        <div class="form-group col-md-6">
                            <label>Email:</label>
                            <input type="email" class="form-control" id="checkInEmail" placeholder="Enter user email" required />
                        </div>

                        <div class="form-group col-md-6">
                            <label>Password:</label>
                            <div class="password-wrapper">
                                <input type="password" class="form-control" id="checkInPassword" placeholder="Enter password" required />
                                <i class="fa fa-eye toggle-password" id="toggleCheckInPasswordIcon"></i>
                            </div>
                        </div>
                    </div>-->

                    <!-- GRID -->
                    <table class="table table-bordered table-sm w-100" id="toolCheckinGrid" style="overflow-x:auto;">
                        <thead class="thead-light">
                            <tr>
                                <th style="width:15%;">Tool Name</th>
                                <th style="width:15%;">Assigned To</th>

                                <th style="width:15%;">Serial No</th>
                                <th style="width:10%;">Part No</th>
                                <th style="width: 15%;">Action</th>
                                <th style="width:23%;">Notes</th>
                                <th style="width:17%;">Hours</th> <!-- ✅ New -->
                                <th style="width:20%;">Rating</th> <!-- ✅ New -->
                            </tr>
                        </thead>
                        <tbody id="toolCheckinGridBody"></tbody>
                    </table>

                </form>
            </div>

            <!-- Footer -->
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
                <button id="btnCheckin" type="submit" form="checkInForm" class="btn btn-success btn-sm">Confirm Check-In</button>
            </div>

        </div>
    </div>
</div>






<!-- Modal Transaction -->
<div id="TransactionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg custom-modal-width" role="document">
        <div class="modal-content">
            <div class="custom-modal-header ModalHeaderColor">
                <h5 class="custom-modal-title lbl_ ModalLabelColor">Transaction History</h5>

            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left side with green background color -->
                    <div class="row">
                        @*Left side (Table Grid)*@
                        <div class="col-md-12 table-container" style="height:400px">

                            <table id="transactionTable" class="table table-striped table-bordered" style="width:100%;">
                                <thead class="sticky-header">
                                    <tr>

                                        @* <th>Tool Id</th>*@
                                        <th style="width:10px;">Tool Name</th>
                                        <th style="width:20px;">Tool Serial No.</th>
                                        <th style="width:10px;">Part No.</th>
                                        <th>Tran. Type</th>
                                        <th>Tran. Qty</th>
                                        <th>Tran. Date</th>
                                        <th>Expected Return Date</th>
                                        @*<th>User Id</th>*@
                                        <th>Username</th>
                                        <th>Notes</th>
                                        <th>Hours</th> <!-- ✅ New -->
                                        <th>Rating</th> <!-- ✅ New -->
                                    </tr>

                                </thead>
                                <tbody style="text-align:center"></tbody>
                            </table>

                        </div>
                    </div>
                </div>



            </div>
            <div class="modal-footer">
                <button id="btnTransactionPO" type="button" class="btn btnClose" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="checkoutUrl" value="@Url.Action("CheckOut","Tool")" />


<script src="~/Scripts/Message.js"></script>
<script>
    $(document).on('change', '#selectAllTools', function () {
        let checked = $(this).is(':checked');
        $('.toolCheckbox').prop('checked', checked);
    });


    $(document).on("click", "#btnMultiCheckout", function () {

        let selected = $(".toolCheckbox:checked");

        if (selected.length === 0) {
            MsgToast("Warning!", "Please select at least one tool to Check-Out.", "warning");
            return;
        }

        loadUsersDropdown().done(function () {
            openCheckoutModal(selected);
        });

    });







    function loadUsersDropdown() {
        return $.ajax({
            url: '/Tool/GetUsersForCheckout',
            type: 'GET',
            dataType: 'json',
            success: function (users) {

                let $ddl = $("#loadUsersDropdown");
                $ddl.empty();
                $ddl.append(`<option value="">-- Select User --</option>`);

                users.forEach(u => {
                    $ddl.append(`<option value="${u.ID}">${u.NAME}</option>`);
                });
            }
        });
    }






    function openCheckoutModal(selected) {
        let toolIds = [];
        let toolNames = [];

        selected.each(function () {
            toolIds.push($(this).data("toolid"));
            toolNames.push($(this).data("toolname"));
        });

        $("#checkoutToolIds").val(toolIds.join(","));

        populateCheckoutGrid(toolIds, toolNames).always(function () {
            $("#checkOutModal").modal("show");
        });
    }



// --------------------
// Populate Checkout Grid
// --------------------
    function populateCheckoutGrid(toolIds, toolNames) {
        var deferred = $.Deferred();

        $("#modalLoader").show();

        let $tbody = $("#toolGridBody");
        $tbody.empty();

        if (!toolIds || toolIds.length === 0) {
            $("#modalLoader").hide();
            deferred.resolve();
            return deferred.promise();
        }

        let loadCount = 0;
        let total = toolIds.length;

        let today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        let defaultDate = today.toISOString().split('T')[0];

        toolIds.forEach((id, i) => {
            let name = toolNames[i];
            let row = `
<tr data-toolid="${id}">
    <td style="text-align:center; width:20%;">${name}</td>
    <td style="width:20%;"><select class="form-control serialDropdown" data-toolid="${id}" multiple="multiple" style="width:100%;"></select></td>
    <td style="width:15%;"><select class="form-control partDropdown" data-toolid="${id}" multiple="multiple" style="width:100%;"></select></td>
    <td style="width:15%;"><input type="date" class="form-control expectedDate" value="${defaultDate}" style="width:100%;" /></td>
    <td><input type="text" class="form-control noteField" placeholder="Enter note" /></td>
</tr>`;
            $tbody.append(row);

            // load serials & parts; wait both then increment loadCount
            $.when(loadSerialDropdown(id), loadPartDropdown(id)).always(function () {
                loadCount++;
                if (loadCount === total) {
                    $("#modalLoader").hide();
                    deferred.resolve();
                }
            });
        });

        return deferred.promise();
    }


// --------------------
// Load Serials Dropdown
// --------------------
function loadSerialDropdown(toolId) {
    let $dropdown = $(`.serialDropdown[data-toolid="${toolId}"]`);
    $dropdown.html('<option disabled selected>Loading...</option>');
    return $.get('@Url.Action("GetAvailableSerials", "Tool")', { toolId: toolId })
        .done(function (data) {
            $dropdown.empty();
            if (data && data.length) {
                data.forEach(item => $dropdown.append(`<option value="${item.SerialId}">${item.SerialNumber}</option>`));
            } else {
                $dropdown.append('<option disabled>No serials available</option>');
            }
            // init multiselect
            if ($dropdown.data('multiselect')) $dropdown.multiselect('destroy');
            $dropdown.multiselect({ includeSelectAllOption: true, enableFiltering: true, maxHeight: 200, buttonWidth: '100%', nonSelectedText: 'Select Serial', numberDisplayed: 1, templates: { ul: '<ul class="multiselect-container dropdown-menu" style="z-index: 2000; position: absolute;"></ul>' } });
        })
        .fail(function () {
            $dropdown.html('<option disabled>Error loading</option>');
        });
}


// --------------------
// Load Parts Dropdown
// --------------------
function loadPartDropdown(toolId) {
    let $dropdown = $(`.partDropdown[data-toolid="${toolId}"]`);
    $dropdown.html('<option disabled selected>Loading...</option>');

    return $.get('@Url.Action("GetPartNo", "Tool")', { toolId: toolId })
        .done(function (data) {
            $dropdown.empty();
            if (data && data.length > 0) {
                $.each(data, function (i, item) {
                    $dropdown.append(`<option value="${item.PartId}">${item.PartNo}</option>`);
                });
            } else {
                $dropdown.append('<option disabled>No parts available</option>');
            }

            $dropdown.multiselect({
                includeSelectAllOption: true,
                enableFiltering: true,
                maxHeight: 200,
                buttonWidth: "100%",
                nonSelectedText: "Select Part",
                numberDisplayed: 1,
                dropdownParent: $("body"),
                templates: {
                    ul: '<ul class="multiselect-container dropdown-menu" style="z-index: 2000; position: absolute;"></ul>'
                }
            });
        })
        .fail(function () {
            $dropdown.html('<option disabled>Error loading</option>');
        });
}


$(document).on("click", "#btnCheckout", function (e) {debugger
    e.preventDefault();

    let checkoutItems = [];

    let userId = Number($("#loadUsersDropdown").val());

    let userName = $("#loadUsersDropdown option:selected").text();





    if (userId <= 0) {
        MsgToast("Warning!", "Please select a user.", "warning");
        return;
    }

    $("#toolGridBody tr").each(function () {

        let row = $(this);
        let toolId = parseInt(row.data("toolid")) || 0;
        let toolName = row.find("td:first").text().trim();

        // ✔ Read selected serials (original select)
        let serialIds = row.find(".serialDropdown").val() || [];
        let partIds = row.find(".partDropdown").val() || [];

        let expectedReturn = row.find(".expectedDate").val() || null;
        let notes = row.find(".noteField").val() || "";

        if (serialIds.length === 0 && partIds.length === 0) return;

        checkoutItems.push({
            ToolId: toolId,
            ToolName: toolName,
            UserId: userId,
            UserName: userName,
            SerialIds: serialIds.map(Number),
            SerialNumbers: [],
            PartIds: partIds.map(Number),
            PartNumbers: [],
            ExpectedReturn: expectedReturn,
            Notes: notes
        });
    });

    console.log("FINAL checkoutItems:", checkoutItems);

    if (checkoutItems.length === 0) {
        MsgToast("Warning!", "Please select serials or parts.", "warning");
        return;
    }

    $.ajax({
        url: '@Url.Action("CheckOut", "Tool")',
        type: 'POST',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify({ CheckoutItems: checkoutItems }),
        success: function (res) {
            if (res.success) {
                MsgToast("Success!", res.message, "success");
                $("#checkOutModal").modal("hide");
                LoadData();
            } else {
                MsgToast("Error!", res.message, "error");
            }
        }
    });
});






// --------------------
// Reset on Modal Close
// --------------------
$('#checkOutModal').on('hidden.bs.modal', function () {
    $("#toolGridBody").empty();
    $("#loadUsersDropdown").val("");
});





    $(document).off("click", "#btnMultiCheckin").on("click", "#btnMultiCheckin", function () {


        $("#toolCheckinGridBody").empty();     // ✅ remove all rows
        $("#checkinToolIds").val("");          // ✅ reset selected tool IDs
        $(".serialCheckinCheckbox").prop("checked", false);


    let selected = $(".toolCheckbox:checked");

    if (selected.length === 0) {
        MsgToast("Warning!", "Please select at least one tool to Check-In.", "warning");
        return;
    }

    let toolIds = [];
    let toolNames = [];

    selected.each(function () {
        let id = $(this).data("toolid");
        if (!toolIds.includes(id)) {
            toolIds.push(id);
            toolNames.push($(this).data("toolname"));
        }
    });

    $("#checkinToolIds").val(toolIds.join(","));
    populateCheckinGrid(toolIds, toolNames);
        $("#checkInModal").modal("show");

});


function populateCheckinGrid(toolIds, toolNames) {
    $("#modalLoader").show();
    let $tbody = $("#toolCheckinGridBody");
    $tbody.empty();

    let loadCount = 0;

    toolIds.forEach((id, i) => {
        let name = toolNames[i];
        $.when(loadAllocatedSerialsWithPartsGrouped(id, name)).always(() => {
            loadCount++;
            if (loadCount === toolIds.length) $("#modalLoader").hide();
        });
    });
}

    function loadAllocatedSerialsWithPartsGrouped(toolId, toolName) {
        $("#toolCheckinGridBody tr[data-toolid='" + toolId + "']").remove();

    let $tbody = $("#toolCheckinGridBody");

    let serialPromise = $.get('@Url.Action("GetAllocatedToolSerials", "Tool")', { toolId: toolId });
    let partPromise = $.get('@Url.Action("GetAllocatedPartNos", "Tool")', { toolId: toolId });

    return $.when(serialPromise, partPromise).done((serialRes, partRes) => {

        let serialData = serialRes[0];
        let partData = partRes[0];
        let partNos = (partData && partData.length > 0) ? partData.map(p => p.PartNo) : [];

        if (!serialData || serialData.length === 0) {
            $tbody.append(`
                <tr>
                    <td>${toolName}</td>
                    <td colspan="6" class="text-muted text-center">No allocated serials</td>
                </tr>
            `);
            return;
        }

        // ✅ Fix duplicates
        let uniqueSerials = [];
        serialData.forEach(s => {
            if (!uniqueSerials.some(u => u.SerialId === s.SerialId)) {
                uniqueSerials.push(s);
            }
        });

        uniqueSerials.forEach((item, index) => {

            let partNo = partNos[index] || "<span class='text-muted'>N/A</span>";

            let row = `
                <tr class="serial-row" data-toolid="${toolId}" data-serialid="${item.SerialId}" data-serialno="${item.SerialNumber}">
                    ${index === 0 ? `<td rowspan="${uniqueSerials.length}" style="vertical-align:middle; font-weight:600;">${toolName}</td>` : ""}

    <td>${item.AllocatedUser || "<span class='text-muted'>N/A</span>"}</td>
                    <td><input type="checkbox" class="serialCheckinCheckbox mr-1" /> ${item.SerialNumber}</td>
                    <td>${partNo}</td>

                    <td>
                        <select class="form-control form-control-sm repairAction" disabled>
                            <option value="">--Select--</option>
                            <option value="Repair">Repair</option>
                            <option value="Broken">Broken</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </td>

                    <td><input type="text" class="form-control form-control-sm noteField" placeholder="Enter note or condition" /></td>

                    <td><input type="number" class="form-control form-control-sm hoursField" placeholder="0" min="0" /></td>

                    <td>
                        <div class="star-rating" data-value="0">
                            <span data-star="1">★</span>
                            <span data-star="2">★</span>
                            <span data-star="3">★</span>
                            <span data-star="4">★</span>
                            <span data-star="5">★</span>
                        </div>
                    </td>
                </tr>`;
            $tbody.append(row);
        });

        // ✅ repair dropdown logic
        $tbody.find(".serialCheckinCheckbox").off("change").on("change", function () {
            $(this).closest("tr").find(".repairAction").prop("disabled", !$(this).is(":checked"));
        });

        // ✅ star rating logic
        $tbody.find(".star-rating span").off("click").on("click", function () {
            let ratingValue = $(this).data("star");
            let $container = $(this).closest(".star-rating");

            $container.attr("data-value", ratingValue);

            $container.find("span").each(function () {
                $(this).toggleClass("selected-star", $(this).data("star") <= ratingValue);
            });

        });

    });
}






// ✅ Load Parts
function loadAllocatedParts(toolId) {
    let $dropdown = $(`.partDropdown[data-toolid='${toolId}']`);
    $dropdown.empty();

    return $.get('@Url.Action("GetAllocatedPartNos", "Tool")', { toolId: toolId }, function (data) {
        if (!data || data.length === 0) {
            $dropdown.append('<option disabled selected>No Parts Available</option>');
            $dropdown.prop("disabled", true);
        } else {
            $.each(data, function (i, item) {
                $dropdown.append(new Option(item.PartNo, item.PartId));
            });
            $dropdown.prop("disabled", false);
        }

        // refresh dropdown
        if ($dropdown.data('multiselect')) $dropdown.multiselect('destroy');
        initializeMultiselect($dropdown);
    });
    }

$("#btnCheckin").click(function (e) {
    e.preventDefault();

    //let email = $("#checkInEmail").val();
    //let password = $("#checkInPassword").val();

    //if (!email || !password) {
    //    MsgToast("Warning!", "Please enter your email and password.", "warning");
    //    return;
    //}

    let checkinList = [];

    $("#toolCheckinGridBody tr.serial-row").each(function () {

        let row = $(this);
        let toolId = row.data("toolid");

        // ✅ ToolName detect correctly (first rowspan OR above rows)
        let toolName = row.find("td[rowspan]").text().trim();
        if (!toolName) {
            toolName = row.prevAll("tr").find("td[rowspan]").first().text().trim();
        }

        // ✅ Hours
        let hours = row.find(".hoursField").val() || 0;

        // ✅ Rating
        let rating = parseInt(row.find(".star-rating").attr("data-value")) || 0;

        // ✅ Notes
        let notes = row.find(".noteField").val() || "";

        // ✅ Serial details
        let isChecked = row.find(".serialCheckinCheckbox").is(":checked");
        let repairAction = row.find(".repairAction").val() || "";
        let isRepair = repairAction !== "";


        let serialItems = [];
        if (isChecked) {
            serialItems.push({
                SerialId: row.data("serialid"),
                SerialNo: row.data("serialno"),
                IsRepair: isRepair,
                RepairAction: repairAction,
                Hours: parseFloat(hours) || 0,
                Rating: parseInt(rating) || 0
            });
        }

        checkinList.push({
            ToolId: toolId,
            ToolName: toolName,
            SerialItems: serialItems,
            PartIds: [],
            PartNo: [],
            Notes: notes,
            Hours: hours,
            Rating: rating
        });

    });

    // ✅ Send Ajax
    $.ajax({
        url: '@Url.Action("CheckIn", "Tool")',
        type: 'POST',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify({
            //email: email,
            //password: password,
            checkins: checkinList
        }),
        success: function (response) {
            if (response.success) {
                MsgToast("Success!", "Tools Checked-In Successfully", "success");
                $("#checkInModal").modal("hide");
                LoadData();
            } else {
                MsgToast("Error!", response.message, "error");
            }
        },
        error: function () {
            MsgToast("Error!", "Something went wrong while processing Check-In.", "error");
        }
    });
});


    // ✅ Modal band ho — sab saaf ho jaye
    $('#checkInModal').on('hidden.bs.modal', function () {
        $("#toolCheckinGridBody").empty();
    });

    // ✅ Modal open ho — fresh start
    $('#checkInModal').on('show.bs.modal', function () {
        $("#toolCheckinGridBody").empty();
    });





   


    //$(document).on('click', '.toggle-password', function () {
    //    const icon = $(this);
    //    const input = icon.siblings('input');

    //    const isPassword = input.attr('type') === 'password';
    //    input.attr('type', isPassword ? 'text' : 'password');
    //    icon.toggleClass('fa-eye fa-eye-slash');
    //});



    ToggleDataList(false);

    LoadData();
    function LoadData() {
        $('#tblBody').empty();
        $('#lstData').DataTable().clear();
        $('#lstData').DataTable().destroy();
        $("#toolCheckinGridBody").empty();  // ✅ add this
        $("#checkinToolIds").val("");
        var isSingleRow = false;

        $.ajax({

            cache: false,
            type: 'GET',
            url: '/Tool/GetToolList',
            data: {

            },
            datatype: JSON,
            success: function (data) {
                $('#filterString').append(data.filterString);
                $('#tblBody').empty();
                $('#lstData').DataTable().clear();
                $('#lstData').DataTable().destroy();
                console.log("Response from GetToolList:", data);
                $(".toolCheckbox").prop("checked", false);
                $("#toolCheckinGridBody").empty();
                $("#checkinToolIds").val("");
                if (!isSingleRow) {
                    var columnDef = [
                        {
                            "data": null,
                            "title": "<input type='checkbox' id='selectAllTools' />",
                            "className": "text-center",
                            "orderable": false,
                            "width": "30px",
                            "render": function (data, type, row) {
                                return `<input type="checkbox" class="toolCheckbox"
                     data-toolid="${row["ToolId"]}"
                     data-toolname="${row["ToolName"]}" />`;
                            }
                        },
                        { "data": "ToolId", "title": "Tool Id", "width": "50px", "className": "text-center", "visible": false },
                        { "data": "ToolName", "title": "Tool Name", "className": "text-center" },
                        { "data": "PartNum", "title": "Part No.", "className": "text-center" },

                        // Total Qty
                        { "data": "TotalQty", "title": "Total Qty", "className": "text-center" },

                        // Available Qty
                        {
                            "data": "AvailableQty", "title": "Available Qty", "className": "text-center",
                            "render": function (data, type, row) {
                                var d = data?.toString() || "0";
                                return (d === "" || d === "0") ? "0" : d;
                            }
                        },

                        // Current Status
                        { "data": "CurrentStatus", "title": "Current Status", "className": "text-center" },

                        // Is Consumable
                        {
                            "data": "IsConsumable", "title": "Is Consumable", "className": "text-center", "visible": false,
                            "render": function (data) {
                                return (data === true || data === "true" || data === 1) ? "1" : "0";
                            }
                        },

                        // Tool Transaction Link
                        {
                            "data": null, "title": "Tool Transaction", "className": "text-center",
                            "render": function (data, type, row) {
                                return `<a href="#" onclick="TransactionDtl('${row["ToolId"]}')">View</a>`;
                            }
                        },



                    ];



                    ToggleDataList(true);

                    MakeDataGridForTraining('lstGetTool', data.lstGetTool, 0, columnDef, 'buttons', true, true, false, false);

                }
                if (data["ErrorMessage"] != null) {
                    $('.dataTables_empty > p').text(data["ErrorMessage"]);
                }
            },

            onerror: function (r) { r },
            failure: function (r) { r }
        });
    }

    $('#GetToolList').click(function () {
        OpenPage('/Tool/GetTool', 'Mohsin');
    });








    function TransactionDtl(toolId) {
        $('#TransactionModal').modal('show');

        $.ajax({
            url: '/Tool/GetToolTransaction',
            cache: false,
            type: 'GET',
            data: {
                toolId: toolId,
            },
            datatype: JSON,
            success: function (data) {
                var lstToolTransaction = [];
                lstToolTransaction = data.lstToolTransaction;
                $('#transactionTable tbody').empty();
                // Iterate over selected rows and append to table
                for (var i = 0; i < lstToolTransaction.length; i++) {

                    var row = lstToolTransaction[i];

                    var rowDataHtml = '<tr>' +
                        //'<td>' + (row['ToolId'] ?? '') + '</td>' +
                        '<td>' + (row['ToolName'] ?? '-') + '</td>' +
                        '<td>' + (row['ToolSerialNumber'] ?? '-') + '</td>' +
                        '<td>' + (row['PartNo'] ?? '-') + '</td>' +
                        '<td>' + (row['TranType'] ?? '-') + '</td>' +
                        '<td class="text-center">' + (row['TranQty'] ?? '0') + '</td>' +
                        '<td>' + (row['TranDate'] ?? '-') + '</td>' +
                        '<td>' + (row['ExpectedReturnDate'] ?? '-') + '</td>' +
                        //'<td>' + (row['UserId'] ?? '-') + '</td>' +
                        '<td>' + (row['Username'] ?? '-') + '</td>' +
                        '<td>' + (row['Notes'] ?? '') + '</td>' +
                        '<td>' + (row['Hours'] ?? '') + '</td>' +
                        '<td>' + (row['Rating'] ?? '') + '</td>' +
                        '</tr>';

                    $('#transactionTable tbody').append(rowDataHtml);


                }
            },
            error: function (xhr, status, error) {
                // Handle error response
                console.error('Error sending data:', error);
            }
        });

    }
    function MakeDataGridForTraining(tableId, data, tableHeight, columns, buttonId, search, isScrollX, footerFunction, isFramed, detailed, reportTitleId, rowSelection, lstHeight) {
        var isFooter = footerFunction === undefined || footerFunction === false ? false : true;
        var isFramed = isFramed === undefined || isFramed === false ? false : true;
        var isDetailed = detailed === undefined ? false : true;
        var reportTitle = '';

        if (reportTitleId === undefined)
            reportTitle = $('.box-title').text();
        else
            reportTitle = reportTitleId;

        var gridHeight = 0;

        isScrollX = isScrollX === undefined ? false : true;
        if (search === undefined) { search = true; }

        var gridButtonsClass = '';
        var gridSearchBoxClass = '';
        if (isDetailed === true) {
            gridButtonsClass = 'btn-header btn-box-tool';
            gridSearchBoxClass = 'bg-white';
            gridButtonSize = 30;
        }
        else {
            gridButtonsClass = 'btn-header btn-box-tool';
            gridSearchBoxClass = 'btn-box-tool bg-white txtSearch';
            gridButtonSize = 30;
        }

        var boxtool;
        if (search === true) {
            if (isFramed) {
                $('#trHeadSearch').empty();
                boxtool = `
        <div class="search-container">
            <i class="fa fa-search search-icon"></i>
            <input class="txtSearch-frame" id="txtFrameSearch" type="text" placeholder="Search..">
        </div>`;
                $('#trHeadSearch').append(boxtool);
            } else {
                $('#' + buttonId).empty();
                boxtool = `
        <div class="search-container">
            <i class="fa fa-search search-icon"></i>
            <input class="txtSearch-frame" id="txtFrameSearch${tableId}" type="text" placeholder="Search..">
        </div>`;
                $('#' + buttonId).append(boxtool);
            }
        }
        else {
            if (isFramed) {
                $('#trHeadSearch').empty();
                boxtool = '<input class="txtSearch-frame" id="txtFrameSearch" type="text" placeholder="Search.." style="padding-left: 10px !important;" >';
                $('#trHeadSearch').append(boxtool);
            }
            else {
                $('#' + buttonId).empty();

            }
        }

        var table = $('#' + tableId).DataTable({
            order: [],
            createdRow: rowSelection,
            data: data,
            columns: columns,
            paging: true,
            ordering: true,
            searching: search,
            deferRender: true,
            destroy: true,
            pagingType: 'full',
            pageLength: 20,
            scrollCollapse: false,
            scrollX: isScrollX,
            colReorder: true,
            orderClasses: false,
            deferRender: true,
            select: true,
            colResize: true,
            //scrollY: gridHeight,
            autoWidth: true,
            footerCallback: footerFunction,
            language: {
                emptyTable: "<p style=\"text-align:left;\">No record(s) found.</p>",
                zeroRecords: "<p style=\"text-align:left;\">No matching record(s) found</p>",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                oPaginate: {
                    sNext: '<i class="fa fa-angle-right"></i>',
                    sPrevious: '<i class="fa fa-angle-left"></i>',
                    sFirst: '<i class="fa fa-angle-double-left"></i>',
                    sLast: '<i class="fa fa-angle-double-right"></i>'
                }
            },
            "dom": "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-5 dataTables_info' i><'col-sm-6 ms-3 dataTables_paginate' p>>",
            buttons: [
                {
                    extend: 'copyHtml5',
                    footer: true,
                    text: '<span><span class="fa-stack"><i class="fa fa-circle fa-stack-2x" style="color: rgb(244, 164, 37);"></i><i class="fa fa-copy fa-stack-1x" style="color: white;"></i></span></span>',
                    titleAttr: 'Copy',
                    title: reportTitle,
                    filename: 'DataExport',
                    exportOptions: {
                        //columns: ':visible'
                        columns: 'th:not(.notexport)' // Excluding columns while exporting
                    }
                },
                {
                    extend: 'excelHtml5',
                    footer: true,
                    text: '<span><span class="fa-stack"><i class="fa fa-circle fa-stack-2x" style="color: rgb(0, 179, 98);"></i><i class="fa fa-file-excel fa-stack-1x" style="color: white;"></i></span></span>',
                    titleAttr: 'Export to excel',
                    title: reportTitle,
                    filename: 'DataExport', //Added By Tahir
                    exportOptions: {
                        //columns: ':visible'
                        columns: 'th:not(.notexport)'
                    }
                },
                {
                    extend: 'print',
                    footer: true,
                    text: '<span><span class="fa-stack"><i class="fa fa-circle fa-stack-2x" style="color: rgb(0, 204, 255);"></i><i class="fa fa-print fa-stack-1x" style="color: white;"></i></span></span>',
                    titleAttr: 'Print',
                    title: '',
                    messageTop: function () { return '<h4>' + reportTitle + '</h4>'; },
                    filename: 'DataExport',
                    exportOptions: {
                        // columns: ':visible'
                        columns: 'th:not(.notexport)'
                    }
                }
            ],
            select: true,
            //drawCallback: function () {
            //    $.get("/Tool/GetAllocationId", function (allocations) {
            //        allocations.forEach(function (alloc) {
            //            $(`.checkInBtn[data-ToolId='${alloc.ToolId}']`)
            //                .attr("data-allocationid", alloc.AllocationId);
            //        });
            //    });
            //}
        });
        table.buttons().container()
            .appendTo('#buttons');

        table.button(0).nodes().removeClass('btn btn-default buttons-copy buttons-html5');
        table.button(0).nodes().addClass(gridButtonsClass);

        table.button(1).nodes().removeClass('btn btn-default buttons-excel buttons-html5');
        table.button(1).nodes().addClass(gridButtonsClass);

        table.button(2).nodes().removeClass('btn btn-default buttons-excel buttons-html5');
        table.button(2).nodes().addClass(gridButtonsClass);

        var dsgndby = $('.modal-footer > #designedby ').html();

        if (dsgndby === "") {
            $('#designedBy').html($('.desgndBy').html());
        }

        var layoutHeader = $('nav').innerHeight();
        var cardHeader = $('.box-header').innerHeight();
        var tableHeader = $('.dataTables_scrollHead').innerHeight();
        var tableFooter = 0;
        var cardFooterH = 30;

        if (isFooter === true)
            tableFooter = $('.dataTables_scrollFoot').innerHeight();


        var parentHeight = $('#' + lstHeight).innerHeight();
        if (parentHeight == undefined)
            parentHeight = window.innerHeight;
        else
            parentHeight = $('#' + lstHeight).innerHeight();

        if (isFooter === true)
            tableFooter = $('#' + tableId + ' > tfoot').innerHeight();

        var browserHeight = parentHeight;
        if (tableHeight === 0) {
            if (layoutHeader === undefined)
                gridHeight = browserHeight - (cardHeader + tableHeader + tableFooter + cardFooterH);
            else
                gridHeight = browserHeight - (layoutHeader + cardHeader + tableHeader + tableFooter + cardFooterH);
        }
        else { gridHeight = tableHeight; }

        var topHeader = $('#topHeader').innerHeight();
        if (topHeader > 0)
            gridHeight = gridHeight - (topHeader + 1);

        gridHeight = gridHeight - 6;

        $('.dataTables_scrollBody').css('height', gridHeight + 'px');
        table.columns.adjust().draw();

        $('#txtFrameSearch' + tableId).on('keyup change', function () {
            table.search(this.value).draw();
        });
        $('.dataTables_filter').hide();
        table.columns.adjust().draw();


        //return table;
    }
    function MsgToast(msg, title, type) {

        toastr.options = {
            closeButton: true,
            debug: false,
            newestOnTop: false,
            progressBar: true,
            positionClass: 'toast-top-right',
            preventDuplicates: true,
            onclick: null
        };



        var $toast = toastr[type](title, msg); // Wire up an event handler to a button in the toast, if it exists
        $toastlast = $toast;

        if (typeof $toast === 'undefined') {
            return;
        }


    }
    function formatDecimal(data) {
        if (!data) return '';

        data = data.toString().trim();

        // If it's a whole number with .0 (e.g. "123.0") → "123"
        if (/^\d+\.0+$/.test(data)) {
            return data.replace(/\.0+$/, '');
        }

        // If it's numeric with decimals (e.g. "456.50") → "456.5"
        if (/^\d+\.\d+$/.test(data)) {
            return parseFloat(data).toString();
        }

        // Otherwise (alphanumeric or plain int), leave as-is
        return data;
    }

  




    $(function () {
        $('#datepicker-container').datepicker({
            format: 'yyyy.mm.dd',
            autoclose: true,
            todayHighlight: true,
            startDate: new Date() // prevent selecting past dates
        }).datepicker('update', new Date()); // default = today
    });

</script>